{% extends "entities/DefaultEntityUI.html" %}

{% block page_header %}<h1>{{ entity.name }} {{ entity.surname }} <small>{{entityLabel}}</small></h1>{% endblock %}

{% block this_page_js %}
    {{ parent() }}
	 <script src="{{constant('BASE_URL')}}/public/js/customClient.js"></script>
	 <script>
        var group = $.parseJSON('{{ payments | json_encode() | raw }}');
        var rates = $.parseJSON('{{ rates | json_encode() | raw }}');
        var performancetypes = $.parseJSON('{{ performancetypes | json_encode() | raw }}');
        var payments = $.parseJSON('{{ payments | json_encode() | raw }}');
        var paymentformulas = $.parseJSON('{{ paymentformulas | json_encode() | raw }}');
        var paymentforms = $.parseJSON('{{ paymentforms | json_encode() | raw }}');
        var paymentstates = $.parseJSON('{{ paymentstates | json_encode() | raw }}');
     </script>
{% endblock %}


{% block this_page_init_js %}
    {#{ parent() }#}
    $('.deleteEntityFromList').click(function() {
                var r = confirm("Sei sicuro di voler rimuovere questa entità?");
                if (r == true)
                  {
                    var t = $(this);
                    var url = t.data('deleteurl');
                  
                  $.ajax({
                      type: "POST",
                      url: url,
                      data: { _METHOD: "DELETE" },
                      success: function(data){
                        t.parents('tr').remove();
                      }
                    });
                  }
            });
            
    DefaultEntity.init(entitiesConfiguration.{{ entityConfiguration.entityName }});

    
    UIModals.init();
            
    CustomClient.init();
{% endblock %}

{% block admin_content %}
    {# -------------------------------------- PANNELLO ENTITA -------------------------------------- #}
    {% import "macro/entityForm.html" as entityForm %}
    {% if entityConfiguration is defined %}
        {% set fields = entityConfiguration.fields %}
        <div class="row">
            <div class="col-md-6">
            {% embed 'components/co/panel.html' %}
                {% block panelHeadingIcon %}
                    {% set iconClass = 'fa fa-list-alt' %}
                    {% if entityConfiguration.viewParameter.iconClass is defined %}
                        {% set iconClass = entityConfiguration.viewParameter.iconClass %}
                    {% endif %}
                    <i class="{{ iconClass }}"></i>
                {% endblock %}
                {% block panelClose %}{% endblock %}
        		{% block panelHeadingText %}Dati {{ entityConfiguration.singular_label|replace({"_": " "})|capitalize }}{% endblock %}
                {% block body %}
                    {{ entityForm.form(entityConfiguration,entity,ED) }}
                {% endblock %}
            {% endembed %}
            </div>
            
            <div class="col-md-6">
            
            {# -------------------------------------- ANAMNESI -------------------------------------- #}
            
            {% embed 'components/co/panel.html' %}
            {% block panelHeadingIcon %}<i class="{{ entitiesConfiguration.anamnesis.viewParameter.iconClass }}"></i>{% endblock %}
    		{% block panelHeadingText %}
    		    Anamnesi 
        		    {% set anchorAddEntityAttributes = ' data-toggle="modal" data-entityname="anamnesis" id="modal_ajax_demo_btn" data-url="' ~ urlFor('entityModal',{"entityName": "anamnesis"}) ~ '?ED[client_id]=' ~ entity.id ~ '"' %}
                    <a {{ anchorAddEntityAttributes | raw }}  class="ajaxModal" style="margin-bottom:8px">
                        <i class="fa fa-plus"></i> Aggiungi
                	</a>
    		{% endblock %}
    		{% block bodyClass %}panel-scroll ps-container ps-container{% endblock %}
    		{% block bodyStyle %}height:300px{% endblock %}
            {% block body %}  
                <ul class="activities"  id="anamnesisList">
                {% if anamnesis %}
                    {% for a in anamnesis %}
					<li>
						<a class="activity" href="javascript:void(0)">
						    {#<i class="clip-upload-2 circle-icon circle-green"></i>#}
							<span class="desc" style="color:#333">{{ a.value }}</span>
							<div class="time" style="top:10px;color:#888;">
								<i class="fa fa-time bigger-110"></i>
								{{ a.creation_datetime|date("m/d/Y") }}
							</div>
						</a>
					</li>
        			{% endfor %}
                {% endif %}
				</ul>
            {% endblock %}
            {% endembed %}
            
            
            {# -------------------------------------- MEMO -------------------------------------- #}
            
            {% embed 'components/co/panel.html' %}
            {% block panelHeadingIcon %}<i class="{{ entitiesConfiguration.memo.viewParameter.iconClass }}"></i>{% endblock %}
    		{% block panelHeadingText %}
    		    Memo 
    		    {% set anchorAddEntityAttributes = ' data-toggle="modal" data-entityname="memo" id="modal_ajax_demo_btn" data-url="' ~ urlFor('entityModal',{"entityName": "memo"}) ~ '?ED[client_id]=' ~ entity.id ~ '"' %}
                <a {{ anchorAddEntityAttributes | raw }}  class="ajaxModal" style="margin-bottom:8px">
                    <i class="fa fa-plus"></i> Aggiungi
            	</a>
    		{% endblock %}
    		{% block bodyClass %}panel-scroll ps-container messages{% endblock %}
    		{% block bodyStyle %}height:100px{% endblock %}
            {% block body %}  
            
                
                <ul class="todo" id="memoList">
                    {% if memo %}
                    {% for a in memo %}
    				<li>
    					<a class="todo-actions" href="javascript:void(0)">
    					    <i class="fa fa-{% if a.type == 2 %}warning" style="color:#a94442{% elseif a.type == 1 %}bullhorn" style="color:#8a6d3b{% else %}info-circle" style="color:#31708f{% endif %}"></i>
    						<span class="desc" style="opacity: 1; text-decoration: none;">{{ a.value }}</span>
    						<span class="pull-right" style="opacity: 1;color:#888;"> {{ a.creation_datetime|date("m/d/Y")  }}</span>
    					</a>
    				</li>
    			    {% endfor %}
    			    
                    {% endif %}
    			</ul>
                {% endblock %}
            {% endembed %}
                
            
                
            {# -------------------------------------- GROUP RATE -------------------------------------- #}
            
            {% if rates %}
            {% embed 'components/co/panel.html' %}
                {% block panelHeadingIcon %}<i class="fa fa-stethoscope"></i>{% endblock %}
        		{% block panelHeadingText %}Tariffe gruppo {{ group.name }}{% endblock %}
        		{% block panelClass %}panel-white{% endblock %}
        		{% block bodyClass %}panel-scroll ps-container{% endblock %}
        		{% block bodyStyle %}height:100px{% endblock %}
        		
                {% block body %}
        		{% for r in rates %}
        		<a class="btn btn-info group-rates" data-numperformance="{{ r.performance_number }}" data-amount="{{ r.amount }}" data-clientid="{{ entity.id }}" data-name="{{ r.name }}">
					{{ r.name }} {% if  r.performance_number > 1 %}{{ r.performance_number }} Trattamenti {% endif %}</i>
					| {{ r.amount }} €
				</a>
        		{% endfor %}
                {% endblock %}
            {% endembed %}
            <script type="text/javascript">
            </script>
            {% endif %}
            </div>
        </div>
    {% endif %}
    
    
{% import "macro/entityDataTable.html" as entityDataTable %}
{% if entity is defined %}

{# -------------------------------------- PRESTAZIONI -------------------------------------- #}
{% set relatedEntityName = "performance" %}
{% set relatedEntityConfiguration = attribute(entitiesConfiguration,relatedEntityName) %}



{# -------------------------------------- PULSANTE AGGIUNGI ENTITA -------------------------------------- #}

{% set anchorAddEntityAttributes = 'href="' ~  urlFor('entityUI',{"entityName": relatedEntityConfiguration.entityName, "pk": "new"}) ~ '?ED[' ~ entityConfiguration.entityName ~ '_id]=' ~ entity.id ~ '" target="_BLANK"' %}
{% if '_' in relatedEntityName %}
{#% set anchorAddEntityAttributes = 'href="#modalInsert' ~ relatedEntityConfiguration.singular_label ~ '" data-toggle="modal"' %#}
{% set anchorAddEntityAttributes = ' data-toggle="modal" data-entityname="' ~ relatedEntityName ~ '" id="modal_ajax_demo_btn" data-url="' ~ urlFor('entityModal',{"entityName": relatedEntityConfiguration.entityName}) ~ '?ED[' ~ entityConfiguration.entityName ~ '_id]=' ~ entity.id ~ '"' %}
{% set anchorAddEntityClass = ' ajaxModal' %}
{% endif %}
{# -------------------------------------- TABELLA ENTITA -------------------------------------- #}

{% set relatedEntities = performance %}

{% embed 'components/co/panel.html' %}
{% block panelId %}{{ entityConfiguration.entityName }}_{{ relatedEntityName }}{% endblock %}
{% block panelHeadingIcon %}
    {% set iconClass = 'fa fa-list-alt' %}
    {% if relatedEntityConfiguration.viewParameter.iconClass is defined %}
        {% set iconClass = relatedEntityConfiguration.viewParameter.iconClass %}
    {% endif %}
    <i class="{{ iconClass }}"></i>
{% endblock %}
{% block panelHeadingText %}
    {{ relatedEntityConfiguration.plural_label|replace({"_": " "})|capitalize }}
    <a {{ anchorAddEntityAttributes | raw }}  class="{{ anchorAddEntityClass }}" style="margin-bottom:8px">
        <i class="fa fa-plus"></i> Aggiungi {{ relatedEntityConfiguration.singular_label|replace({"_": " "})|capitalize }}
	</a>
{% endblock %}
{% block body %} 

	
    
    {% set EC = relatedEntityConfiguration %}
    {% set entities = relatedEntities %}
    {% set parentEntityName = entityConfiguration.entityName %}
    
    {% set fields = EC.fields %}
    {% set entityLabel = EC.singular_label|replace({"_": " "})|capitalize %}
    {% set fieldVisibleInList = [] %}
    {% set relatedFields = [] %}

    <table class="table table-striped table-bordered table-hover table-full-width  table-min-padding" id="{{ EC.entityName }}EntitiesTable">
		<thead>
			<tr>
			    {#% for fieldDBName,fieldData in fields  if (fieldData.visible is not defined or fieldData.visible != false) 
			        and ( fieldData.visibleInList is not defined or fieldData.visibleInList != false ) 
			        and ( 'own' not in fieldDBName ) 
			        and  fieldDBName != (parentEntityName ~ '_id')
			        %}
			    
			        {% set colHeader = fieldDBName|replace({"_": " "})|capitalize %}
				    {% if fieldData.label is defined %}
				        {% set colHeader = fieldData.label|replace({"_": " "})|capitalize %}
				    {% endif %}
			    
    			    {% if '_id' in fieldDBName %}
				        {% set fieldVisibleInList = fieldVisibleInList|merge([(fieldDBName|replace({"_id": ""}))]) %}
        			{% else %}
				        {% set fieldVisibleInList = fieldVisibleInList|merge([fieldDBName]) %}
        			{% endif %#}
				    
					<th id="performanceid">Id</th>
					<th id="performancedatetime">Data</th>
					<th id="performanceduration">Durata</th>
					<th id="performancereason">Motivazione</th>
					<th id="performancenote">Note/Feedback codificati</th>
					<th id="performanceprestazioni">Prestazioni</th>
					<th id="performanceexecuted">Eseguita</th>
					<th id="performanceduration">Pagamento</th>
				
					
                    <th></th>
			</tr>
		</thead>
	{% for relatedEntity in entities %}
        <tr>
    		<td class="text-center">
		        {% if relatedEntity.id is defined %}
		            {{ relatedEntity.id  }}
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.datetime %}
		            {{ relatedEntity.datetime|date("m/d/Y") }}
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.duration is defined %}
		            {{ relatedEntity.duration }}
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.reason is defined %}
		            {{ relatedEntity.reason }}
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.note is defined %}
		            {{ relatedEntity.note }}
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.ownPerformance_performancetype is defined %}
		            {%for ptype in relatedEntity.ownPerformance_performancetype %}
		               <button {% if ptype.note %}data-original-title="{{ performancetypes[ptype.performancetype_id] }}" data-content="{{ ptype.note }}" data-placement="top" data-trigger="hover" class="btn btn-dark-grey btn-xs popovers"{% else %}class="btn btn-xs btn-dark-grey"{% endif %}>
							{{ performancetypes[ptype.performancetype_id] }}
						</button>
		            {% endfor %}
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.executed == 1 %}
		            Si
		        {% else %}
		            No
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.payment_id is defined %}
		            
                    {% set p = payments[relatedEntity.payment_id] %}
                    
                    {{p.name}} - 
                    Pagato: {% if p.paymentstate_id == 1 %}
			            Si
			        {% else %}
			            Non saldato
			        {% endif %} - 
			        Importo : {{ p.amount }} €
			        {% if totalNumOfPerformance[p.id] > 1 %}
			            - 
			            {{ performanceNUmber[relatedEntity.id] }} di {{ totalNumOfPerformance[p.id] }}
			        {% endif %}
		        {% endif %}
		    </td>
		    
		    
		    <td>
			    <a href="{{ urlFor('entityUI', {"entityName": EC.entityName, "pk": relatedEntity.id }) }}" target="_BLANK"  class="btn btn-default"><i class="clip-pencil-3"></i></a>
		    </td>
		</tr>
    {% endfor %}
	</table>

{% endblock %}
{% endembed %}


{# -------------------------------------- PAGAMENTI -------------------------------------- #}
{% set relatedEntityName = "payment" %}
{% set relatedEntityConfiguration = attribute(entitiesConfiguration,relatedEntityName) %}



{# -------------------------------------- PULSANTE AGGIUNGI ENTITA -------------------------------------- #}

{% set anchorAddEntityAttributes = 'href="' ~  urlFor('entityUI',{"entityName": relatedEntityConfiguration.entityName, "pk": "new"}) ~ '?ED[' ~ entityConfiguration.entityName ~ '_id]=' ~ entity.id ~ '" target="_BLANK"' %}
{% if '_' in relatedEntityName %}
{#% set anchorAddEntityAttributes = 'href="#modalInsert' ~ relatedEntityConfiguration.singular_label ~ '" data-toggle="modal"' %#}
{% set anchorAddEntityAttributes = ' data-toggle="modal" data-entityname="' ~ relatedEntityName ~ '" id="modal_ajax_demo_btn" data-url="' ~ urlFor('entityModal',{"entityName": relatedEntityConfiguration.entityName}) ~ '?ED[' ~ entityConfiguration.entityName ~ '_id]=' ~ entity.id ~ '"' %}
{% set anchorAddEntityClass = ' ajaxModal' %}
{% endif %}
{# -------------------------------------- TABELLA ENTITA -------------------------------------- #}

{% set relatedEntities = payments %}

{% embed 'components/co/panel.html' %}
{% block panelId %}{{ entityConfiguration.entityName }}_{{ relatedEntityName }}{% endblock %}
{% block panelHeadingIcon %}
    {% set iconClass = 'fa fa-list-alt' %}
    {% if relatedEntityConfiguration.viewParameter.iconClass is defined %}
        {% set iconClass = relatedEntityConfiguration.viewParameter.iconClass %}
    {% endif %}
    <i class="{{ iconClass }}"></i>
{% endblock %}
{% block panelHeadingText %}
    {{ relatedEntityConfiguration.plural_label|replace({"_": " "})|capitalize }}
    <a {{ anchorAddEntityAttributes | raw }}  class="{{ anchorAddEntityClass }}" style="margin-bottom:8px">
        <i class="fa fa-plus"></i> Aggiungi {{ relatedEntityConfiguration.singular_label|replace({"_": " "})|capitalize }}
	</a>
{% endblock %}
{% block body %} 

	
    
    {% set EC = relatedEntityConfiguration %}
    {% set entities = relatedEntities %}
    {% set parentEntityName = entityConfiguration.entityName %}
    
    {% set fields = EC.fields %}
    {% set entityLabel = EC.singular_label|replace({"_": " "})|capitalize %}
    {% set fieldVisibleInList = [] %}
    {% set relatedFields = [] %}

    <table class="table table-striped table-bordered table-hover table-full-width  table-min-padding" id="{{ EC.entityName }}EntitiesTable">
		<thead>
			<tr>
			    {#% for fieldDBName,fieldData in fields  if (fieldData.visible is not defined or fieldData.visible != false) 
			        and ( fieldData.visibleInList is not defined or fieldData.visibleInList != false ) 
			        and ( 'own' not in fieldDBName ) 
			        and  fieldDBName != (parentEntityName ~ '_id')
			        %}
			    
			        {% set colHeader = fieldDBName|replace({"_": " "})|capitalize %}
				    {% if fieldData.label is defined %}
				        {% set colHeader = fieldData.label|replace({"_": " "})|capitalize %}
				    {% endif %}
			    
    			    {% if '_id' in fieldDBName %}
				        {% set fieldVisibleInList = fieldVisibleInList|merge([(fieldDBName|replace({"_id": ""}))]) %}
        			{% else %}
				        {% set fieldVisibleInList = fieldVisibleInList|merge([fieldDBName]) %}
        			{% endif %#}
				    
					<th id="paymentid">Id</th>
					<th id="paymentname">Nome</th>
					<th id="paymentamount">Importo</th>
					<th id="paymentpaymentstate_id">Riscosso</th>
					<th id="paymentcollection_date">Data incasso</th>
					{#<th id="paymentcreation_datetime">Data creazione</th>
					<th id="paymentupdate_datetime">Data aggiornamento</th>#}
					<th id="paymentgroup">Gruppo</th>
					<th id="paymentpaymentformula_id">Formula di pagamento</th>
					<th id="paymentpaymentform_id">Forma di pagamento</th>
                    <th></th>
			</tr>
		</thead>
	{% for relatedEntity in entities %}
        <tr>
    		<td class="text-center">
		        {% if relatedEntity.id is defined %}
		            {{ relatedEntity.id  }}
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.name is defined %}
		            {{ relatedEntity.name }}
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.amount is defined %}
		            {{ relatedEntity.amount }}
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.paymentstate_id == 1 %}
		            Si
		        {% else %}
		            No
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.collection_date is defined %}
		            {{ relatedEntity.collection_date|date("m/d/Y") }}
		        {% endif %}
		    </td>
    		{#<td class="text-center">
		        {% if relatedEntity.creation_datetime is defined %}
		            {{ relatedEntity.creation_datetime|date("m/d/Y") }}
		        {% endif %}
		    </td>
    		<td class="text-center">
		        {% if relatedEntity.update_datetime is defined %}
		            {{ relatedEntity.update_datetime|date("m/d/Y") }}
		        {% endif %}
		    </td>#}
    		<td>
		        {% if relatedEntity.paymentgroup_nominal_number_of_performance > 1 %}
		            Gruppo di {{ relatedEntity.paymentgroup_nominal_number_of_performance }} prestazioni.
		            Valido dal {{ relatedEntity.paymentgroup_nominal_start_datetime|date("m/d/Y") }} al {{ relatedEntity.paymentgroup_nominal_end_datetime|date("m/d/Y") }}
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.paymentformula_id is defined %}
		            {{ paymentformulas[relatedEntity.paymentformula_id]["name"] }}
		        {% endif %}
		    </td>
    		<td>
		        {% if relatedEntity.paymentform_id is defined %}
		            {{ paymentforms[relatedEntity.paymentform_id]["name"] }}
		        {% endif %}
		    </td>
		    
		    
		    <td>
			    <a href="{{ urlFor('entityUI', {"entityName": EC.entityName, "pk": relatedEntity.id }) }}" target="_BLANK"  class="btn btn-default"><i class="clip-pencil-3"></i></a>
		    </td>
		</tr>
    {% endfor %}
	</table>

{% endblock %}
{% endembed %}

{% endif %}
    
<div id="ajax-modal" class="modal fade" tabindex="-1" style="display: none;"></div>
{% endblock %}
     
